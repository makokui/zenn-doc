---
title: "(編集中)Copilot Studio から会話履歴を Azure OpenAI にわたす"
emoji: "😎"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

# はじめに
前回の記事に引き続き、[Microsoft Teams](https://www.microsoft.com/ja-jp/microsoft-teams/log-in) から [Copilot Studio](https://www.microsoft.com/ja-jp/microsoft-copilot/microsoft-copilot-studio) で [Azure OpenAI Service](https://learn.microsoft.com/ja-JP/azure/ai-services/openai/overview) を呼び出すにあたり、会話履歴を認識させるようにしてみます。  
記事は 2024 年 3 月 22 日時点の内容を元に執筆しています。常に最新の情報を確認するようにしてください。

## 前回の記事で実装した仕組みの問題点
Azure OpenAI Services は会話履歴を保持していません。Azure OpenAI Services はクライアント (この場合、Copilot Studio) から送られてきたメッセージの内容だけを見て応答しています。このため、クライアントからのメッセージに会話履歴が含まれていない場合には、「それについて、もう少し詳しく教えて。」「いまの回答とは別のアイデアはないですか？」といった直前のやりとりを加味した会話が成立しない状態になります。  

## 対応策
クライアントから Azure OpenAI Service に会話履歴を含めてリクエストを発行するようにリクエストパラメータを変更します。  
この実装にあたっては、会話履歴の持ち方についての検討が必要になります。
一般的な会話履歴の管理方法には、以下のような方法が考えられます。  
(本記事では１．の方法を紹介します。)  

### １．Copilot Studio のグローバル変数で会話履歴を管理する  
Copilot Studio のチャットが

### ２．会話履歴をデータベースなどで管理する  
Microsoft Teams (Copilot Studio) の会話履歴は、Dataverse の [ConversationTranscript](https://learn.microsoft.com/ja-jp/power-apps/developer/data-platform/reference/entities/conversationtranscript) テーブルに格納されています。  
この仕組みを利用して Copilot Studio から Power Automate を呼び出し、会話履歴を Dataverse の ConversationTranscript テーブルから取得する、といった方法が考えられます。もちろん、CosmosDB などを使用して独自に会話履歴を管理することも可能です。  

ConversationTranscript テーブルの確認方法は、[Work with conversation transcripts](https://learn.microsoft.com/microsoft-copilot-studio/analytics-sessions-transcripts) で説明されています。  

簡単に確認してみます。  
１．[PowerApps](https://www.powerapps.com/) にアクセスします。  
２．「テーブル」から「すべて」を選択し、右上の検索ボックスで「ConversationTranscript」を入力するとテーブルが確認できます。  
![](/images/a46162600af970/2024-03-30-05-19-05.png)  

データはこのような感じで格納されています。  
![](/images/a46162600af970/2024-03-30-05-24-03.png)  

会話履歴は「内容」カラムで確認できますが、以下のように Unicode エスケープシーケンスされて格納されているます。内容を確認したい場合には[変換ツール](https://www.bing.com/search?q=Unicode+%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9)を利用するなりしてください。  
![](/images/a46162600af970/2024-03-30-05-25-36.png)  


## グローバル変数で会話履歴を保持する実装例
話がそれましたが、本筋に戻ります。この記事では、１．の方法で実装してみます。  

前回の記事では、何かのメッセージを受けると、Azure OpenAI Services に REST API でそのままメッセージを飛ばし、応答をチャットの戻す、という実装を行いました。  
会話履歴を Azure OpenAI Services に連携させるには、REST API を呼び出す直前に過去の会話履歴を取得し、REST API からの応答後に会話履歴を保存する必要があります。フローで示すとこの部分になります。  
![](/images/a46162600af970/2024-03-30-05-41-57.png)  

### グローバル変数の初期化

トピック（システム）から「会話の開始」を有効化し、グローバル変数として会話履歴（ここでは、"conversation_history" とします。）を保持する変数を初期化します。  
![](/images/a46162600af970/2024-03-30-05-51-26.png)  

次に、会話の終了時にグローバル変数を初期化するため、「トピック」の「最初からやり直す」を有効化します。  
![](/images/a46162600af970/2024-03-30-05-54-57.png)  

また、上記から呼び出される「トピック（システム）」の「会話をリセットする」を有効化します。  
![](/images/a46162600af970/2024-03-30-05-55-36.png)  

「会話をリセットする」の規定のフローの中で変数が初期化されます。  
![](/images/a46162600af970/2024-03-30-05-57-43.png)  

:::message alert
会話履歴を管理するグローバル変数を何らかのタイミングで解放しない場合には、どこかでアプリケーションがクラッシュするか Azure OpenAI Services が受け付けられるサイズの上限にひっかかり、適切に処理が動作しなくなることが考えられます。  
この実装では、会話履歴のデータサイズや会話回数（10 回など）を元に何らかのタイミングで初期化してください。  
:::

### 会話履歴の保存  
前回の記事で作成したフローの「値の解析」と最後にチャットとして応答する「Message」の間にノードを追加します。「アクションを呼び出す」-「フローの作成」を行います。  
![](/images/a46162600af970/2024-03-30-06-20-34.png)  

#### フローの概要 (会話履歴の保存)
Copilot Studio から、以下のデータを受け取ります。  
1) グローバル変数に保持されている会話履歴  
2) 直近の Azure OpenAI Services へのメッセージ (質問)  
3) 直近の Azure OpenAI Services からメッセージ (質問) に対する応答  

1. の会話履歴に 2. と 3. のデータを追加した新しい会話履歴データを生成し、Copilot Studio に返します。  


以下は実装の参考になるように詳細を記述しています。本当に実装する気合のある人だけ読み進めてください。　　

#### １．入力パラメータの設定
Copilot Studio から受け取るパラメータを定義します。  
ここではすべて「テキスト」で以下の 3 つを定義します。  
- HistoryDataString  
- QuestionString  
- AnswerString  
![](/images/a46162600af970/2024-03-30-06-24-20.png)  

#### ２．処理変数の初期化
内部処理のため、以下の変数を定義します。  
Value はすべて空にします。  
- NewHistoryString (Type:String)  
- tmpHistoryDataJson (Type:Object)  
- tmpHistoryDataArray (Type:Array)  
- NewQuestionJson (Type:Array)  
- NewAnswerJson (Type:Array)  
![](/images/a46162600af970/2024-03-30-06-26-44.png)  

#### ３．現会話履歴データの作成  
![](/images/a46162600af970/2024-03-30-06-29-22.png)  

CopilotStudio からの渡された会話履歴パラメータ (HistoryDataString) のサイズの有無で条件分岐させます。  

![](/images/a46162600af970/2024-03-30-06-29-57.png)  

入力パラメータの「HistoryDataString」を指定すると以下のように変換されます。実行環境に依存するので直接コードをタイプするのではなく、Length() 関数の中に入れる変数は動的コンテンツから指定します。  
![](/images/a46162600af970/2024-03-30-06-33-03.png)  


##### ３－１．会話履歴がある場合

![](/images/a46162600af970/2024-03-30-06-36-14.png)  

Copilot から渡された会話履歴 (HistoryDataString) を Parse します。  
![](/images/a46162600af970/2024-03-30-06-59-24.png)  
データ定義にはこちらを使用します。  
```json
{
    "type": "object",
    "properties": {
        "history": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "role": {
                        "type": "string"
                    },
                    "content": {
                        "type": "string"
                    }
                },
                "required": [
                    "role",
                    "content"
                ]
            }
        }
    }
}
```

次に、先ほど Parse した Json の本文データを「tmpHistoryDataJson」変数に格納します。  
![](/images/a46162600af970/2024-03-30-06-39-01.png)  


最後に Parse した Json の history データを「tmpHistoryArray」配列に格納します。  
![](/images/a46162600af970/2024-03-30-06-39-18.png)  


##### ３－２．会話履歴がない場合
tmpHistoryDataJson 変数を以下のよう history 配列を空で定義します。  
![](/images/a46162600af970/![](/images/a46162600af970/2024-03-30-06-39-37.png).png)  

#### ４．直近の質問から Json 形式のデータを作成
新しい会話履歴データに格納する直近の質問データを「NewQuestionJson」変数を更新します。  
![](/images/a46162600af970/2024-03-30-06-44-56.png)  


#### ５．直近の質問に対する Azure OpenAI Services からの回答から Json 形式のデータを作成
新しい会話履歴データに格納する直近の質問に対する回答データを「NewAnswerJson」変数を更新します。  
![](/images/a46162600af970/2024-03-30-06-45-49.png)  

#### 新しい会話履歴データの更新
「NewHistoryData」変数を「現行の会話履歴」「直近の質問」「直近の質問に対する回答」をマージして作成します。  
![](/images/a46162600af970/2024-03-30-06-46-14.png)  

#### 新しい会話履歴データの応答
先で作成した「NewHistoryData」変数を Copilot Studio に戻します。  
![](/images/a46162600af970/2024-03-30-06-47-15.png)  

 
作成した PowerAutomate は適当な名前を付けて保存した後、Copilot Studio 側で PowerAutomate に渡すパラメータを指定します。  
**Input**:  
- HistoryDataString: Global.conversation_history (グローバル変数の会話履歴)  
- QuestionString: Activbity.Text (チャットメッセージ)  
- AnswerString: Output (Azure OpenAI Serices の応答を Parse した応答メッセージ)  

**Output**:  
- historydatastring: Global.conversation_history (グローバル変数の会話履歴)  
![](/images/a46162600af970/2024-03-30-07-03-38.png)  

これで会話履歴が、Global 変数に格納されるようになりました。  


### 会話履歴の取得  
会話履歴が保存できるようになったので、次に会話履歴の取得処理を実装します。先ほどの会話履歴の保存と同様にこちらも PowerAutomate で処理を行います。

#### フローの概要 (会話履歴の取得)

Copilot Studio から、以下のデータを受け取ります。  
1) グローバル変数に保持されている会話履歴  
2) Azure OpenAI Services へのシステムメッセージ    
3) Azure OpenAI Services へのメッセージ (質問)   

上記の3つのデータから Azure OpenAI Service に渡す会話履歴を含むメッセージを生成し、Copilot Studio に返します。  


以下も本当に実装する気合のある人だけ読み進めてください。　　

#### １．入力パラメータの設定
Copilot Studio から受け取るパラメータを定義します。  
ここではすべて「テキスト」で以下の 3 つを定義します。  
- HistoryDataString  
- SystemMessageString  
- QuestionString  
![](/images/a46162600af970/2024-03-30-07-15-36.png) 



#### ２．処理変数の初期化
内部処理のため、変数を定義します。  
![](/images/a46162600af970/2024-03-30-07-19-11.png)  

以下の変数の Value はすべて空にします。  
- NewSystemMessageJson (Type:Array)  
- NewQuestionJson (Type:Array)  
- NewMessage (Type:String)  
tmpMessage は以下で定義します。  
- tmpMessage (Type:Object)  
  ![](/images/a46162600af970/2024-03-30-07-20-37.png)  

次に入力パラメータから変数を更新します。  
Azure OpenAI Services へのシステムメッセージから「NewSystemMessageJson」変数を更新します。  
![](/images/a46162600af970/2024-03-30-08-01-43.png)  

Azure OpenAI Services へのメッセージ (質問) から「NewQuestionJson」変数を更新します。  
![](/images/a46162600af970/2024-03-30-08-02-43.png)  


#### ３．現会話履歴データの作成  
![](/images/a46162600af970/2024-03-30-08-05-06.png)

CopilotStudio からの渡された会話履歴パラメータ (HistoryDataString) のサイズの有無で条件分岐させます。  

![](/images/a46162600af970/![](/images/a46162600af970/2024-03-30-06-29-57.png)%20%20.png)

![](/images/a46162600af970/2024-03-30-08-06-31.png)


##### ３－１．会話履歴がある場合

![](/images/a46162600af970/2024-03-30-08-07-16.png)  

Copilot から渡された会話履歴 (HistoryDataString) を Parse します。  
![](/images/a46162600af970/2024-03-30-08-07-29.png)  
データ定義にはこちらを使用します。  
```json
{
    "type": "object",
    "properties": {
        "history": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "role": {
                        "type": "string"
                    },
                    "content": {
                        "type": "string"
                    }
                },
                "required": [
                    "role",
                    "content"
                ]
            }
        }
    }
}
```

次に、先ほど Parse した Json の history データから role と content を抽出します。  
![](/images/a46162600af970/2024-03-30-08-08-17.png)  

最後に新しいメッセージを作成します。
![](/images/a46162600af970/2024-03-30-08-08-44.png)



##### ３－２．会話履歴がない場合

![](/images/a46162600af970/2024-03-30-08-09-21.png)  

以下のように新しいメッセージを作成します。
![](/images/a46162600af970/2024-03-30-08-09-47.png)


#### ４．新しい会話履歴データの応答
先で作成した「NewMessage」変数を Copilot Studio に戻します。  
![](/images/a46162600af970/2024-03-30-08-11-15.png)  


 
作成した PowerAutomate は適当な名前を付けて保存した後、Copilot Studio 側で PowerAutomate に渡すパラメータを指定します。  
**Input**:  
- HistoryDataString: Global.conversation_history (グローバル変数の会話履歴)  
- SystemMessageString: "You are an AI assistant that helps people find information." (ここでは、Azure OpenAI Services の規定のシステムメッセージを定義)　　
- QuestionString: Activbity.Text (チャットメッセージ)  

**Output**:  
- aoaistringmessage: 他の用途で使用していない任意の string 変数  

![](/images/a46162600af970/2024-03-30-08-11-48.png)


上記を Json に Parse します。  
![](/images/a46162600af970/2024-03-30-08-15-54.png)  


![](/images/a46162600af970/2024-03-30-08-17-10.png)
```JSON
{
  	messages:Topic.ParseMessages.messages,
  	max_tokens: 800,
  	temperature: 0.7,
  	frequency_penalty: 0,
  	presence_penalty: 0,
  	top_p: 0.95,
  	stop: Blank()
}
```


![](/images/a46162600af970/2024-03-30-08-21-10.png)
